<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Agenda</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .font-retro { font-family: 'Courier New', Courier, monospace; letter-spacing: -0.5px; }
        .font-paper { font-family: 'Georgia', 'Times New Roman', Times, serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const Icon = ({ path, className, onClick, style }) => (
            <svg onClick={onClick} style={style} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const ChevronLeft = (props) => <Icon {...props} path={<><path d="m15 18-6-6 6-6"/></>} />;
        const ChevronRight = (props) => <Icon {...props} path={<><path d="m9 18 6-6-6-6"/></>} />;
        const Settings = (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;
        const BookOpen = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const PenTool = (props) => <Icon {...props} path={<><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />;
        const Save = (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const CheckCircle2 = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />;
        const AlertCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />;
        const X = (props) => <Icon {...props} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />;
        const Moon = (props) => <Icon {...props} path={<><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/><path d="M19 3v4"/><path d="M21 5h-4"/></>} />;
        const Sun = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} />;
        const CalendarIcon = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const ListIcon = (props) => <Icon {...props} path={<><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>} />;
        const Flame = (props) => <Icon {...props} path={<><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3 1.12.8 2.18 1.5 3.3Z"/></>} />;
        const Copy = (props) => <Icon {...props} path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />;
        const Square = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" /></>} />;
        const CheckSquare = (props) => <Icon {...props} path={<><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />;
        const Coffee = (props) => <Icon {...props} path={<><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></>} />;
        const MoonStars = (props) => <Icon {...props} path={<><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/><path d="M19 3v4"/><path d="M21 5h-4"/></>} />;

        const { useState, useEffect, useRef } = React;
        const PERIODS = [0, 1, 2, 3, 4, 5, 6];

        const THEMES = {
            modern_indigo: { id: 'modern_indigo', name: 'Modern Indigo', class: 'indigo', font: 'font-sans', hex: '#6366f1', type: 'modern' },
            modern_emerald: { id: 'modern_emerald', name: 'Modern Forest', class: 'emerald', font: 'font-sans', hex: '#10b981', type: 'modern' },
            modern_rose: { id: 'modern_rose', name: 'Modern Rose', class: 'rose', font: 'font-sans', hex: '#f43f5e', type: 'modern' },
            retro_green: { id: 'retro_green', name: 'Retro Terminal', class: 'green', font: 'font-retro', hex: '#22c55e', type: 'retro' },
            paper_blue: { id: 'paper_blue', name: 'Academic Paper', class: 'blue', font: 'font-paper', hex: '#3b82f6', type: 'paper' },
        };

        const getMinutes = (timeStr) => {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };
        
        const formatTime = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            const ampm = h >= 12 && h !== 24 ? 'PM' : 'AM';
            const displayH = h % 12 || 12;
            return `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`;
        };

        const SCHEDULES = {
            REGULAR: {
                0: [getMinutes("7:25"), getMinutes("8:22")],
                1: [getMinutes("8:30"), getMinutes("9:27")],
                2: [getMinutes("9:34"), getMinutes("10:36")],
                3: [getMinutes("10:51"), getMinutes("11:48")],
                4: [getMinutes("11:55"), getMinutes("12:52")],
                5: [getMinutes("13:29"), getMinutes("14:26")],
                6: [getMinutes("14:33"), getMinutes("15:30")]
            },
            TUESDAY: {
                0: [getMinutes("7:25"), getMinutes("8:13")],
                1: [getMinutes("9:24"), getMinutes("10:12")],
                2: [getMinutes("10:19"), getMinutes("11:12")],
                3: [getMinutes("11:27"), getMinutes("12:15")],
                4: [getMinutes("12:22"), getMinutes("13:10")],
                5: [getMinutes("13:47"), getMinutes("14:35")],
                6: [getMinutes("14:42"), getMinutes("15:30")]
            }
        };

        const PERIOD_COLORS = {
            0: { border: 'border-l-purple-500', badge: 'bg-purple-100 text-purple-800', darkBadge: 'bg-purple-900 text-purple-100' },
            1: { border: 'border-l-blue-500', badge: 'bg-blue-100 text-blue-800', darkBadge: 'bg-blue-900 text-blue-100' },
            2: { border: 'border-l-green-500', badge: 'bg-green-100 text-green-800', darkBadge: 'bg-green-900 text-green-100' },
            3: { border: 'border-l-yellow-500', badge: 'bg-yellow-100 text-yellow-800', darkBadge: 'bg-yellow-900 text-yellow-100' },
            4: { border: 'border-l-orange-500', badge: 'bg-orange-100 text-orange-800', darkBadge: 'bg-orange-900 text-orange-100' },
            5: { border: 'border-l-red-500', badge: 'bg-red-100 text-red-800', darkBadge: 'bg-red-900 text-red-100' },
            6: { border: 'border-l-pink-500', badge: 'bg-pink-100 text-pink-800', darkBadge: 'bg-pink-900 text-pink-100' },
            'morning': { border: 'border-l-teal-500', badge: 'bg-teal-100 text-teal-800', darkBadge: 'bg-teal-900 text-teal-100' },
            'evening': { border: 'border-l-indigo-500', badge: 'bg-indigo-100 text-indigo-800', darkBadge: 'bg-indigo-900 text-indigo-100' },
        };

        const getPSTDate = () => {
            const now = new Date();
            const pstString = now.toLocaleDateString('en-US', {
                timeZone: 'America/Los_Angeles',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const [month, day, year] = pstString.split('/').map(Number);
            return new Date(year, month - 1, day);
        };

        const formatDateKey = (date) => {
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        };

        const formatDateDisplay = (date) => {
            const today = getPSTDate();
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffTime = d.getTime() - today.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays === -1) return 'Yesterday';
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        };

        const TimeBlock = ({ 
            id, type, start, end, label, icon, 
            data, defaultClass, isDarkMode, activeTheme, 
            onInputChange, onToggle, onCopy, isActive, 
            currentMinutes 
        }) => {
            const isGap = type === 'gap';
            const colors = PERIOD_COLORS[id] || PERIOD_COLORS['morning'];
            const homeworkDone = data?.homeworkDone || false;

            let progress = -1;
            let periodProgress = 0;
            if (isActive && currentMinutes >= start && currentMinutes <= end) {
                progress = ((currentMinutes - start) / (end - start)) * 100;
                periodProgress = progress;
            }

            const isRetro = activeTheme.type === 'retro';
            const isPaper = activeTheme.type === 'paper';
            
            let cardBg = isDarkMode ? 'bg-gray-800 shadow-md border-gray-700' : 'bg-white shadow-sm';
            if (isRetro) cardBg = 'bg-black border-green-900 shadow-none border';
            if (isPaper) cardBg = 'bg-[#fdfbf7] shadow-sm border-gray-200';

            let inputColor = isDarkMode ? 'text-gray-100 placeholder-gray-500' : 'text-gray-800 placeholder-gray-400';
            if (isRetro) inputColor = 'text-green-400 placeholder-green-900';
            
            let badgeClass = isDarkMode ? colors.darkBadge : colors.badge;
            if (isRetro) badgeClass = 'bg-green-900 text-green-400 border border-green-700';

            return (
                <div className="flex relative group print-break">
                    <div className="w-16 md:w-20 flex-shrink-0 flex flex-col items-center relative timeline-col">
                        <div className={`absolute top-0 bottom-0 w-px ${isRetro ? 'bg-green-900' : (isDarkMode ? 'bg-gray-700' : 'bg-gray-300')} left-1/2 -translate-x-1/2`}></div>
                        <div className={`relative z-10 text-[10px] font-bold py-1 px-2 rounded-full mb-1 ${isActive ? `bg-${activeTheme.class}-100 text-${activeTheme.class}-700` : (isRetro ? 'bg-black text-green-700 border border-green-900' : (isDarkMode ? 'bg-gray-800 text-gray-400 border border-gray-700' : 'bg-white text-gray-500 border border-gray-200'))}`}>
                            {formatTime(start)}
                        </div>
                    </div>

                    <div className="flex-1 pb-6 relative print-full-width">
                        {progress >= 0 && (
                            <div 
                                className="absolute -left-[calc(2.5rem+1px)] md:-left-[calc(2.5rem+1px)] w-[calc(100%+2.5rem)] flex items-center z-20 pointer-events-none transition-all duration-1000 no-print"
                                style={{ top: `${progress}%` }}
                            >
                                <div className={`w-2.5 h-2.5 rounded-full ${isRetro ? 'bg-green-500' : 'bg-red-500'} -ml-1.5 ring-2 ring-white dark:ring-gray-900`}></div>
                                <div className={`flex-1 h-0.5 ${isRetro ? 'bg-green-500' : 'bg-red-500'} shadow-[0_0_8px_rgba(239,68,68,0.6)]`}></div>
                            </div>
                        )}

                        <div 
                            className={`rounded-xl border-l-4 overflow-hidden transition-all hover:shadow-md relative ${cardBg} ${isRetro ? 'border-l-green-500' : colors.border} ${isActive ? `ring-2 ring-offset-2 ring-${activeTheme.class}-500 dark:ring-offset-gray-900` : ''}`}
                        >
                            <div className="p-4">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-3 w-full">
                                        <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-1 ${badgeClass}`}>
                                            {icon}
                                            {label}
                                        </span>
                                        {!isGap && (
                                            <input 
                                                type="text"
                                                placeholder={defaultClass || "Add Subject..."}
                                                value={data.subject !== undefined ? data.subject : (defaultClass || '')}
                                                onChange={(e) => onInputChange(id, 'subject', e.target.value)}
                                                className={`font-bold text-lg border-none focus:ring-0 p-0 bg-transparent flex-1 ${inputColor} ${activeTheme.font}`}
                                            />
                                        )}
                                        {isGap && <span className={`text-sm ${isRetro ? 'text-green-700' : (isDarkMode ? 'text-gray-500' : 'text-gray-400')}`}>Free Time</span>}
                                    </div>
                                    {isActive && <span className={`animate-pulse text-xs font-bold text-${activeTheme.class}-500 uppercase tracking-widest px-2 no-print`}>Now</span>}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className={`rounded-lg p-3 group focus-within:ring-2 focus-within:ring-${activeTheme.class}-500/20 transition-all ${isRetro ? 'bg-green-900/10 border border-green-900' : (isPaper ? 'bg-white border border-gray-100' : (isDarkMode ? 'bg-gray-700/50' : 'bg-gray-50'))}`}>
                                        <div className={`flex items-center justify-between mb-2 text-xs font-semibold uppercase tracking-wider ${isRetro ? 'text-green-600' : 'text-gray-500'}`}>
                                            <div className="flex items-center gap-2">
                                                <PenTool className="w-3 h-3" />
                                                <span>{isGap ? 'To-Do' : 'Classwork / Notes'}</span>
                                            </div>
                                            {!isGap && (
                                                <button onClick={() => onCopy(id, 'notes')} className={`text-gray-400 hover:text-${activeTheme.class}-500 transition-colors no-print`} title="Copy from yesterday">
                                                    <Copy className="w-3.5 h-3.5" />
                                                </button>
                                            )}
                                        </div>
                                        <textarea
                                            placeholder={isGap ? "Tasks..." : "Class notes..."}
                                            value={data.notes || ''}
                                            onChange={(e) => onInputChange(id, 'notes', e.target.value)}
                                            className={`w-full bg-transparent border-none p-0 text-sm focus:ring-0 resize-none min-h-[60px] ${inputColor} ${activeTheme.font}`}
                                        />
                                    </div>

                                    {!isGap && (
                                        <div className={`rounded-lg p-3 group transition-all border ${
                                            !homeworkDone
                                            ? (isRetro ? 'bg-green-900/20 border-green-500' : (isDarkMode ? 'bg-red-900/20 border-red-700/50' : 'bg-red-100 border-red-200')) 
                                            : (isRetro ? 'bg-transparent border-green-900' : (isDarkMode ? 'bg-green-900/20 border-green-700/50' : 'bg-green-100 border-green-200'))
                                        }`}>
                                            <div className={`flex items-center justify-between mb-2 text-xs font-semibold uppercase tracking-wider ${
                                                homeworkDone 
                                                    ? (isRetro ? 'text-green-500' : 'text-green-600') 
                                                    : (isRetro ? 'text-green-400' : (isDarkMode ? 'text-red-300' : 'text-red-600'))
                                            }`}>
                                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => onToggle(id, 'homework')}>
                                                    {homeworkDone ? <CheckSquare className="w-4 h-4" /> : <Square className="w-4 h-4" />}
                                                    <span>Homework</span>
                                                </div>
                                                <button onClick={() => onCopy(id, 'homework')} className="opacity-50 hover:opacity-100 transition-opacity no-print" title="Copy from yesterday">
                                                    <Copy className="w-3.5 h-3.5" />
                                                </button>
                                            </div>
                                            <textarea
                                                placeholder="No homework..."
                                                value={data.homework || ''}
                                                onChange={(e) => onInputChange(id, 'homework', e.target.value)}
                                                className={`w-full bg-transparent border-none p-0 text-sm focus:ring-0 resize-none min-h-[60px] ${inputColor} ${activeTheme.font} ${homeworkDone ? 'line-through opacity-50' : ''}`}
                                            />
                                        </div>
                                    )}
                                </div>

                                {isActive && !isGap && (
                                    <div className="absolute bottom-0 left-0 h-1 bg-gray-200/20 w-full no-print">
                                        <div 
                                            className={`h-full bg-${activeTheme.class}-500 transition-all duration-1000`} 
                                            style={{width: `${periodProgress}%`}}
                                        ></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const App = () => {
            const [currentDate, setCurrentDate] = useState(getPSTDate());
            const [agendaData, setAgendaData] = useState({});
            const [defaultClasses, setDefaultClasses] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [isLoaded, setIsLoaded] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [viewMode, setViewMode] = useState('daily');
            const [streak, setStreak] = useState({ count: 0, lastDate: null });
            const [themeId, setThemeId] = useState('modern_indigo');
            const [currentMinutes, setCurrentMinutes] = useState(0);

            useEffect(() => {
                const savedAgenda = localStorage.getItem('student_agenda_data');
                const savedDefaults = localStorage.getItem('student_agenda_defaults');
                const savedTheme = localStorage.getItem('student_agenda_theme_mode');
                const savedStreak = localStorage.getItem('student_agenda_streak');
                const savedThemeId = localStorage.getItem('student_agenda_theme_id');
                
                if (savedAgenda) setAgendaData(JSON.parse(savedAgenda));
                if (savedDefaults) setDefaultClasses(JSON.parse(savedDefaults));
                if (savedTheme) setIsDarkMode(savedTheme === 'dark');
                if (savedStreak) setStreak(JSON.parse(savedStreak));
                if (savedThemeId) setThemeId(savedThemeId);
                setIsLoaded(true);
            }, []);

            useEffect(() => { if (isLoaded) localStorage.setItem('student_agenda_data', JSON.stringify(agendaData)); }, [agendaData, isLoaded]);
            useEffect(() => { if (isLoaded) localStorage.setItem('student_agenda_defaults', JSON.stringify(defaultClasses)); }, [defaultClasses, isLoaded]);
            useEffect(() => { if (isLoaded) localStorage.setItem('student_agenda_streak', JSON.stringify(streak)); }, [streak, isLoaded]);
            useEffect(() => { if (isLoaded) localStorage.setItem('student_agenda_theme_id', themeId); }, [themeId, isLoaded]);

            useEffect(() => {
                if (isLoaded) {
                    localStorage.setItem('student_agenda_theme_mode', isDarkMode ? 'dark' : 'light');
                    if (isDarkMode) document.body.classList.add('dark');
                    else document.body.classList.remove('dark');
                }
            }, [isDarkMode, isLoaded]);

            useEffect(() => {
                const dateKey = formatDateKey(currentDate);
                const dayData = agendaData[dateKey] || {};
                let incompleteCount = 0;
                let totalTasks = 0;

                Object.values(dayData).forEach(p => {
                    if (p.homework && p.homework.trim()) {
                        totalTasks++;
                        if (!p.homeworkDone) incompleteCount++;
                    }
                });

                if (incompleteCount > 0) {
                    document.title = `(${incompleteCount}) Student Agenda`;
                } else if (totalTasks > 0 && incompleteCount === 0) {
                    document.title = "âœ… All Done! - Student Agenda";
                } else {
                    document.title = "Student Agenda";
                }

            }, [agendaData, currentDate]);

            useEffect(() => {
                const updateTime = () => {
                    const now = new Date();
                    const laTimeString = now.toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles', hour12: false, hour: '2-digit', minute: '2-digit' });
                    setCurrentMinutes(getMinutes(laTimeString));
                };
                const interval = setInterval(updateTime, 30000); 
                updateTime();
                return () => clearInterval(interval);
            }, []);

            const getFlatSchedule = () => {
                const day = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                const scheduleConfig = (day === 'Tuesday') ? SCHEDULES.TUESDAY : SCHEDULES.REGULAR;
                const flat = [];
                const startOfSchool = scheduleConfig[0][0]; 
                flat.push({ id: 'morning', type: 'gap', start: 0, end: startOfSchool, label: 'Before School', icon: <Coffee className="w-3 h-3" /> });
                Object.entries(scheduleConfig).forEach(([period, [start, end]]) => {
                    flat.push({ id: parseInt(period), type: 'period', start, end, label: `Period ${period}`, icon: null });
                });
                const endOfSchool = scheduleConfig[6][1]; 
                flat.push({ id: 'evening', type: 'gap', start: endOfSchool, end: 1440, label: 'After School', icon: <MoonStars className="w-3 h-3" /> });
                return flat;
            };

            const navigate = (direction) => {
                const newDate = new Date(currentDate);
                if (viewMode === 'daily') {
                    newDate.setDate(newDate.getDate() + direction);
                } else {
                    newDate.setMonth(newDate.getMonth() + direction);
                }
                setCurrentDate(newDate);
            };

            const jumpToToday = () => setCurrentDate(getPSTDate());
            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const handleInputChange = (period, field, value) => {
                const dateKey = formatDateKey(currentDate);
                setAgendaData(prev => {
                    const dayData = prev[dateKey] || {};
                    const periodData = dayData[period] || {};
                    return {
                        ...prev,
                        [dateKey]: { ...dayData, [period]: { ...periodData, [field]: value } }
                    };
                });
            };

            const handleDefaultClassChange = (period, value) => setDefaultClasses(prev => ({ ...prev, [period]: value }));

            const handleCopyFromYesterday = (period, field) => {
                const yesterday = new Date(currentDate);
                yesterday.setDate(yesterday.getDate() - 1);
                const prevKey = formatDateKey(yesterday);
                const prevData = agendaData[prevKey]?.[period]?.[field];
                if (prevData) handleInputChange(period, field, prevData);
            };

            const triggerConfetti = () => {
                const count = 200;
                const defaults = { origin: { y: 0.7 } };
                function fire(particleRatio, opts) {
                    if (typeof confetti === 'function') {
                        confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
                    }
                }
                fire(0.25, { spread: 26, startVelocity: 55 });
                fire(0.2, { spread: 60 });
                fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                fire(0.1, { spread: 120, startVelocity: 45 });
            };

            const handleToggleComplete = (period, type) => {
                const dateKey = formatDateKey(currentDate);
                const currentStatus = agendaData[dateKey]?.[period]?.[`${type}Done`] || false;
                const newStatus = !currentStatus;
                
                handleInputChange(period, `${type}Done`, newStatus);
                
                if (newStatus) { 
                     const defaults = { origin: { y: 0.7 }, zIndex: 1000 };
                     if (typeof confetti === 'function') {
                        confetti({ ...defaults, particleCount: 40, spread: 50, startVelocity: 40 });
                     }

                    const todayKey = formatDateKey(getPSTDate());
                    const lastKey = streak.lastDate;
                    if (lastKey !== todayKey) {
                        const yesterday = getPSTDate();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayKey = formatDateKey(yesterday);
                        if (lastKey === yesterdayKey) setStreak(prev => ({ count: prev.count + 1, lastDate: todayKey }));
                        else setStreak({ count: 1, lastDate: todayKey });
                    }
                }
            };

            const dateKey = formatDateKey(currentDate);
            const dayData = agendaData[dateKey] || {};
            const activeTheme = THEMES[themeId] || THEMES.modern_indigo;
            
            const isRetro = activeTheme.type === 'retro';
            const isPaper = activeTheme.type === 'paper';

            let bgClass = isDarkMode ? 'bg-gray-900 text-gray-100' : 'bg-gray-50 text-gray-800';
            if (isRetro) bgClass = 'bg-black text-green-500 font-retro';
            if (isPaper) bgClass = 'bg-[#f0eadd] text-slate-800 font-paper'; 

            const headerClass = isDarkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-white shadow-sm';
            const navBtnClass = isDarkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-white text-gray-600 shadow-sm';
            const centerNavClass = isDarkMode ? 'bg-gray-700/50 text-gray-200' : 'bg-gray-100 text-gray-800';

            const getMonthData = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                return { year, month, firstDay: new Date(year, month, 1).getDay(), daysInMonth: new Date(year, month + 1, 0).getDate() };
            };
            const checkDayData = (day) => {
                const testDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const key = formatDateKey(testDate);
                const data = agendaData[key];
                if (!data) return { hasHomework: false, hasNotes: false };
                let hasHomework = false, hasNotes = false;
                Object.values(data).forEach(p => {
                    if (p.homework && p.homework.trim()) hasHomework = true;
                    if (p.notes && p.notes.trim()) hasNotes = true;
                });
                return { hasHomework, hasNotes };
            };

            if (!isLoaded) return null;
            const { year, month, firstDay, daysInMonth } = getMonthData();
            const flatSchedule = getFlatSchedule();
            const isViewingToday = formatDateKey(currentDate) === formatDateKey(getPSTDate());

            return (
                <div className={`min-h-screen pb-20 transition-colors duration-200 ${bgClass} ${activeTheme.font}`}>
                    <header className={`sticky top-0 z-50 transition-colors duration-200 no-print ${isRetro ? 'bg-black border-b border-green-900' : headerClass}`}>
                        <div className="max-w-4xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className={`text-2xl font-bold flex items-center gap-2 ${isRetro ? 'text-green-500' : (isDarkMode ? 'text-white' : 'text-gray-900')}`}>
                                    <BookOpen className={`w-6 h-6 text-${activeTheme.class}-500`} />
                                    My Agenda
                                </h1>
                                <div className="flex items-center gap-2">
                                    <div className={`flex items-center gap-1 px-3 py-1 rounded-full ${isRetro ? 'bg-green-900/30 text-green-500 border border-green-800' : (isDarkMode ? 'bg-orange-900/30 text-orange-400' : 'bg-orange-50 text-orange-600')}`}>
                                        <Flame className="w-4 h-4 fill-current" />
                                        <span className="font-bold text-sm">{streak.count}</span>
                                    </div>
                                    <div className="w-px h-6 bg-gray-300 dark:bg-gray-700 mx-1"></div>
                                    
                                    <button onClick={() => setViewMode(viewMode === 'daily' ? 'calendar' : 'daily')} className={`p-2 rounded-full transition-colors ${isDarkMode ? `text-${activeTheme.class}-400 hover:bg-gray-700` : `text-${activeTheme.class}-600 hover:bg-gray-100`}`} title="Toggle View"><CalendarIcon className="w-5 h-5" /></button>
                                    <button onClick={toggleTheme} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'text-yellow-400 hover:bg-gray-700' : 'text-gray-500 hover:bg-gray-100'}`}>{isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}</button>
                                    <button onClick={() => setShowSettings(true)} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-500 hover:bg-gray-100'}`}><Settings className="w-5 h-5" /></button>
                                </div>
                            </div>
                            <div className={`flex items-center justify-between p-1 rounded-lg transition-colors ${isRetro ? 'bg-green-900/10 border border-green-900' : centerNavClass}`}>
                                <button onClick={() => navigate(-1)} className={`p-2 rounded-md transition-all ${navBtnClass}`}><ChevronLeft className="w-5 h-5" /></button>
                                <div className="flex items-center gap-2">
                                    <button onClick={jumpToToday} className={`text-xs font-bold uppercase tracking-wider px-3 py-1 rounded-md transition-colors ${isRetro ? 'text-green-500 hover:bg-green-900/30' : (isDarkMode ? `hover:bg-gray-600 text-${activeTheme.class}-400` : `hover:bg-white text-${activeTheme.class}-600`)}`}>Go to Today</button>
                                    <div className="flex flex-col items-center leading-tight">
                                        <span className={`font-semibold text-lg ${isRetro ? 'text-green-400' : (isDarkMode ? 'text-gray-100' : 'text-gray-800')}`}>
                                            {viewMode === 'daily' ? formatDateDisplay(currentDate) : currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </span>
                                        {viewMode === 'daily' && (['Today', 'Tomorrow', 'Yesterday'].includes(formatDateDisplay(currentDate))) && (
                                            <span className={`text-xs ${isRetro ? 'text-green-600' : (isDarkMode ? 'text-gray-400' : 'text-gray-500')}`}>{currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                        )}
                                    </div>
                                </div>
                                <button onClick={() => navigate(1)} className={`p-2 rounded-md transition-all ${navBtnClass}`}><ChevronRight className="w-5 h-5" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto px-4 py-6">
                        {viewMode === 'daily' ? (
                            <div className="space-y-0">
                                {flatSchedule.map((block) => (
                                    <TimeBlock 
                                        key={block.id}
                                        {...block}
                                        data={dayData[block.id] || {}}
                                        defaultClass={defaultClasses[block.id]}
                                        isDarkMode={isDarkMode}
                                        activeTheme={activeTheme}
                                        onInputChange={handleInputChange}
                                        onToggle={handleToggleComplete}
                                        onCopy={handleCopyFromYesterday}
                                        isActive={isViewingToday && currentMinutes >= block.start && currentMinutes <= block.end}
                                        currentMinutes={currentMinutes}
                                    />
                                ))}
                                <div className="w-20 flex-shrink-0 flex flex-col items-center relative h-8 timeline-col">
                                    <div className={`absolute top-0 bottom-0 w-px ${isRetro ? 'bg-green-900' : (isDarkMode ? 'bg-gray-700' : 'bg-gray-300')} left-1/2 -translate-x-1/2`}></div>
                                    <div className={`relative z-10 text-[10px] font-bold py-1 px-2 rounded-full ${isRetro ? 'bg-black text-green-700 border border-green-900' : (isDarkMode ? 'bg-gray-800 text-gray-400 border border-gray-700' : 'bg-white text-gray-500 border border-gray-200')}`}>
                                        12:00 AM
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className={`rounded-xl shadow-md p-4 animate-in fade-in zoom-in duration-200 ${isRetro ? 'bg-black border border-green-800' : (isDarkMode ? 'bg-gray-800' : 'bg-white')}`}>
                                <div className="grid grid-cols-7 mb-4 text-center">
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                        <div key={day} className={`text-xs font-bold uppercase tracking-wider ${isRetro ? 'text-green-600' : (isDarkMode ? 'text-gray-400' : 'text-gray-500')}`}>{day}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {Array(firstDay).fill(null).map((_, i) => <div key={`empty-${i}`} className="aspect-square"></div>)}
                                    {Array(daysInMonth).fill(null).map((_, i) => {
                                        const day = i + 1;
                                        const { hasHomework, hasNotes } = checkDayData(day);
                                        const dateObj = new Date(year, month, day);
                                        const isToday = formatDateKey(new Date()) === formatDateKey(dateObj);
                                        return (
                                            <button key={day} onClick={() => { setCurrentDate(dateObj); setViewMode('daily'); }}
                                                className={`aspect-square rounded-xl flex flex-col items-center justify-center relative transition-all hover:scale-105 active:scale-95 border-2 ${isToday ? `border-${activeTheme.class}-500 bg-${activeTheme.class}-50 dark:bg-${activeTheme.class}-900/30` : (isRetro ? 'border-green-900 hover:bg-green-900/20' : (isDarkMode ? 'border-gray-700 hover:bg-gray-700' : 'border-gray-100 hover:bg-gray-50'))}`}
                                            >
                                                <span className={`text-sm font-semibold ${isToday ? `text-${activeTheme.class}-600 dark:text-${activeTheme.class}-400` : (isRetro ? 'text-green-500' : (isDarkMode ? 'text-gray-200' : 'text-gray-700'))}`}>{day}</span>
                                                <div className="flex gap-1 mt-1.5 h-1.5">
                                                    {hasHomework && <div className="w-1.5 h-1.5 rounded-full bg-red-500 ring-1 ring-white dark:ring-gray-800"></div>}
                                                    {hasNotes && <div className={`w-1.5 h-1.5 rounded-full bg-${activeTheme.class}-500 ring-1 ring-white dark:ring-gray-800`}></div>}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <div className="text-center pt-8 text-gray-400 text-sm no-print">
                            <p>Changes are saved automatically to this device.</p>
                        </div>
                    </main>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 settings-modal">
                            <div className={`rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200 ${isDarkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDarkMode ? 'bg-gray-900/50 border-gray-700' : 'bg-gray-50 border-gray-100'}`}>
                                    <h2 className={`text-lg font-bold flex items-center gap-2 ${isDarkMode ? 'text-gray-100' : 'text-gray-800'}`}>
                                        <Settings className="w-5 h-5 text-gray-500" />
                                        Schedule Settings
                                    </h2>
                                    <button onClick={() => setShowSettings(false)} className={`transition-colors ${isDarkMode ? 'text-gray-400 hover:text-white' : 'text-gray-400 hover:text-gray-600'}`}><X className="w-5 h-5" /></button>
                                </div>
                                <div className="p-6 max-h-[70vh] overflow-y-auto">
                                    <div className="mb-6">
                                        <label className={`block text-xs font-bold uppercase tracking-wider mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>Theme</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {Object.entries(THEMES).map(([key, data]) => (
                                                <button 
                                                    key={key}
                                                    onClick={() => setThemeId(key)}
                                                    className={`px-3 py-2 rounded-lg text-sm font-medium border-2 text-left flex items-center gap-2 transition-all ${themeId === key ? `border-${data.class}-500 bg-${data.class}-50 dark:bg-${data.class}-900/20 text-${data.class}-700 dark:text-${data.class}-300` : (isDarkMode ? 'border-gray-700 text-gray-400 hover:bg-gray-700' : 'border-gray-200 text-gray-600 hover:bg-gray-50')}`}
                                                >
                                                    <div className="w-3 h-3 rounded-full" style={{background: data.hex}}></div>
                                                    {data.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <p className={`text-sm mb-4 font-bold ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>Default Classes</p>
                                    <div className="space-y-3">
                                        {PERIODS.map(period => (
                                            <div key={period} className="flex items-center gap-3">
                                                <span className={`w-8 h-8 flex items-center justify-center rounded-full text-xs font-bold ${isDarkMode ? PERIOD_COLORS[period].darkBadge : PERIOD_COLORS[period].badge}`}>{period}</span>
                                                <input type="text" placeholder={`Class Name for Period ${period}`} value={defaultClasses[period] || ''} onChange={(e) => handleDefaultClassChange(period, e.target.value)} className={`flex-1 rounded-lg text-sm focus:border-${activeTheme.class}-500 focus:ring-${activeTheme.class}-500 ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'}`} />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className={`px-6 py-4 flex justify-end ${isDarkMode ? 'bg-gray-900/50' : 'bg-gray-50'}`}>
                                    <button onClick={() => setShowSettings(false)} className={`bg-${activeTheme.class}-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-${activeTheme.class}-700 transition-colors shadow-sm flex items-center gap-2`}><Save className="w-4 h-4" /> Save Changes</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
